<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>AI Sanitizator & Rewriter</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <style type="text/tailwindcss">
        :root {
            --primary: #1e40af;
            --secondary: #d946ef;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #05050A;
        }
        .bg-ambient {
            background-image: 
                radial-gradient(circle at 20% 0%, rgba(30, 27, 75, 0.4) 0%, transparent 50%),
                radial-gradient(circle at 80% 10%, rgba(30, 58, 138, 0.2) 0%, transparent 40%);
            background-attachment: fixed;
        }
        .glass-card {
            background: rgba(10, 10, 15, 0.45);
            backdrop-filter: blur(32px);
            -webkit-backdrop-filter: blur(32px);
            border: 1px solid rgba(255, 255, 255, 0.06);
            box-shadow: 0 35px 60px -15px rgba(0, 0, 0, 0.6);
        }
        textarea::-webkit-scrollbar, .diff-view::-webkit-scrollbar {
            width: 6px;
        }
        textarea::-webkit-scrollbar-track, .diff-view::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.01);
        }
        textarea::-webkit-scrollbar-thumb, .diff-view::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 99px;
        }
        textarea::-webkit-scrollbar-thumb:hover, .diff-view::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        .input-glow:focus-within {
            box-shadow: 0 0 40px -10px rgba(30, 58, 138, 0.25);
            border-color: rgba(30, 58, 138, 0.4);
        }
        @keyframes subtle-float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }
        .animate-float {
            animation: subtle-float 6s ease-in-out infinite;
        }
        .loader {
            border-top-color: #3b82f6;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .btn-glow-gold {
             box-shadow: 0 0 15px rgba(217, 119, 6, 0.15);
        }
        .btn-glow-blue {
             box-shadow: 0 0 25px rgba(29, 78, 216, 0.25);
        }
        .diff-added {
            background: rgba(34, 197, 94, 0.12);
            color: #86efac;
            border-left: 2px solid rgba(34, 197, 94, 0.4);
            padding: 1px 4px;
        }
        .diff-removed {
            background: rgba(239, 68, 68, 0.12);
            color: #fca5a5;
            text-decoration: line-through;
            border-left: 2px solid rgba(239, 68, 68, 0.4);
            padding: 1px 4px;
        }
        .diff-view {
            font-family: 'Inter', sans-serif;
            font-size: 0.875rem;
            line-height: 1.7;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .strength-slider {
            -webkit-appearance: none;
            appearance: none;
            height: 4px;
            border-radius: 99px;
            outline: none;
            background: linear-gradient(to right, #22c55e, #eab308, #ef4444);
        }
        .strength-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 0 8px rgba(0,0,0,0.4);
        }
        .para-score {
            transition: all 0.2s ease;
        }
        .para-score:hover {
            transform: scale(1.02);
        }
        .tab-active {
            border-bottom: 2px solid #3b82f6;
            color: white;
        }
        .tab-inactive {
            border-bottom: 2px solid transparent;
            color: #64748b;
        }
        .tab-inactive:hover {
            color: #94a3b8;
        }
    </style>
</head>

<body
    class="bg-ambient text-slate-300 min-h-screen flex flex-col items-center justify-center p-4 selection:bg-blue-500/30">
    <div class="w-full max-w-4xl mx-auto space-y-8 animate-fade-in py-12">
        <nav class="flex justify-center items-center mb-4">
            <div
                class="flex items-center gap-3 px-5 py-2 rounded-full bg-white/5 border border-white/5 backdrop-blur-md">
                <span class="material-symbols-outlined text-blue-400/80 text-xl">auto_fix_high</span>
                <span class="text-sm font-medium text-slate-300 tracking-wide">AI Sanitizator</span>
            </div>
        </nav>

        <header class="text-center space-y-3 mb-10">
            <h1 class="text-3xl md:text-5xl font-semibold tracking-tight text-white pb-1 drop-shadow-lg">
                Clean & Enhance Your Text
            </h1>
            <p class="text-slate-400 text-base md:text-lg max-w-lg mx-auto font-light leading-relaxed">
                Remove invisible characters or rewrite content with advanced AI logic.
            </p>
        </header>

        <main class="glass-card rounded-[2rem] p-6 md:p-10 transition-all duration-500" id="input-panel">
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mb-6">
                <div class="flex items-center gap-3">
                    <label
                        class="group relative inline-flex items-center justify-center px-5 py-2.5 text-sm font-medium text-slate-300 transition-all duration-300 bg-slate-900/40 border border-slate-700/30 rounded-xl hover:bg-slate-800/60 hover:text-white cursor-pointer hover:border-blue-500/20 overflow-hidden shadow-sm">
                        <span
                            class="material-symbols-outlined text-[20px] mr-2 text-blue-400/80 group-hover:text-blue-300 transition-colors">upload_file</span>
                        Upload Document
                        <input accept=".txt,.docx,.pdf,.html" class="hidden" id="fileInput" type="file" />
                    </label>
                </div>
                <button
                    class="text-xs font-medium text-slate-500 hover:text-red-300 transition-colors flex items-center gap-1.5 px-3 py-1.5 rounded-lg hover:bg-white/5 tracking-wide"
                    onclick="clearText()">
                    <span class="material-symbols-outlined text-[16px]">delete</span>
                    Clear Canvas
                </button>
            </div>

            <div class="relative group">
                <textarea
                    class="w-full h-72 bg-[#0a0a0f]/60 text-slate-200 placeholder-slate-600 border border-slate-800/60 rounded-2xl p-6 text-base leading-relaxed focus:ring-0 focus:border-blue-500/30 focus:bg-[#0c0c14]/80 transition-all duration-300 resize-y input-glow font-mono md:font-sans shadow-inner"
                    id="rawText" placeholder="Paste your content here to begin..."></textarea>

                <div
                    class="mt-4 flex flex-col md:flex-row justify-between items-start md:items-center gap-4 border-t border-white/5 pt-4">
                    <div class="flex items-center gap-4 text-xs text-slate-500">
                        <span class="uppercase tracking-wider font-semibold opacity-60">Supported Formats:</span>
                        <div class="flex gap-3">
                            <div class="flex items-center gap-1 hover:text-slate-300 transition-colors cursor-help"
                                title=".html files">
                                <span class="material-symbols-outlined text-[16px]">code</span> .HTML
                            </div>
                            <div class="flex items-center gap-1 hover:text-slate-300 transition-colors cursor-help"
                                title=".pdf files">
                                <span class="material-symbols-outlined text-[16px]">picture_as_pdf</span> .PDF
                            </div>
                            <div class="flex items-center gap-1 hover:text-slate-300 transition-colors cursor-help"
                                title=".docx files">
                                <span class="material-symbols-outlined text-[16px]">draft</span> .DOCX
                            </div>
                            <div class="flex items-center gap-1 hover:text-slate-300 transition-colors cursor-help"
                                title=".txt files">
                                <span class="material-symbols-outlined text-[16px]">description</span> .TXT
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Strength Slider -->
            <div class="mt-6 bg-slate-900/40 border border-slate-800/40 rounded-xl p-4" id="strengthControl">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-2">
                        <span class="material-symbols-outlined text-purple-400/80 text-[18px]">tune</span>
                        <span class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Humanization Strength</span>
                    </div>
                    <span class="text-xs font-bold px-2.5 py-0.5 rounded-full" id="strengthLabel"
                        style="background: rgba(234, 179, 8, 0.15); color: #facc15;">Medium</span>
                </div>
                <input type="range" min="0" max="2" value="1" class="w-full strength-slider" id="strengthSlider"
                    oninput="updateStrengthLabel(this.value)" />
                <div class="flex justify-between text-[10px] text-slate-600 mt-1 px-0.5">
                    <span>Light</span>
                    <span>Medium</span>
                    <span>Aggressive</span>
                </div>
            </div>

            <div class="mt-10 flex flex-col md:flex-row gap-5 justify-center items-stretch md:items-center">
                <button
                    class="group relative flex items-center justify-center gap-4 px-6 py-4 bg-slate-900/60 border border-slate-700/50 rounded-xl hover:bg-slate-800 hover:border-amber-500/30 btn-glow-gold transition-all duration-300 w-full md:w-64"
                    onclick="processText('clean')">
                    <div class="bg-amber-500/10 p-2 rounded-lg group-hover:bg-amber-500/20 transition-colors">
                        <span class="material-symbols-outlined text-amber-400/80 text-xl">cleaning_services</span>
                    </div>
                    <div class="flex flex-col items-start text-left">
                        <span class="text-sm font-semibold text-slate-200 group-hover:text-white">
                            Sanitize Only
                        </span>
                        <span class="text-[10px] text-slate-500 uppercase tracking-wider font-medium">Remove hidden
                            chars</span>
                    </div>
                </button>

                <button
                    class="group relative flex items-center justify-center gap-4 px-6 py-4 bg-gradient-to-r from-blue-900/90 to-indigo-900/90 border border-blue-700/40 rounded-xl hover:brightness-110 btn-glow-blue transition-all duration-300 w-full md:w-64 transform hover:-translate-y-0.5 shadow-lg"
                    onclick="processText('rewrite')">
                    <div class="bg-blue-400/10 p-2 rounded-lg group-hover:bg-blue-400/20 transition-colors">
                        <span class="material-symbols-outlined text-blue-300 text-xl">auto_awesome</span>
                    </div>
                    <div class="flex flex-col items-start text-left">
                        <span class="text-sm font-bold text-white">
                            Clean & Rewrite
                        </span>
                        <span class="text-[10px] text-blue-200/60 uppercase tracking-wider font-medium">AI Logic
                            Enhancement</span>
                    </div>
                    <div class="absolute inset-0 rounded-xl ring-1 ring-inset ring-white/10 pointer-events-none"></div>
                </button>
            </div>

            <div class="hidden mt-8 text-center" id="loading">
                <div
                    class="inline-flex flex-col items-center gap-3 bg-slate-950/60 px-8 py-4 rounded-2xl border border-white/5 backdrop-blur-sm">
                    <div class="loader ease-linear rounded-full border-2 border-t-2 border-blue-500/30 h-6 w-6"></div>
                    <span class="text-xs text-slate-400 font-medium tracking-widest uppercase animate-pulse">Processing
                        AI Logic...</span>
                </div>
            </div>
        </main>

        <div class="hidden space-y-6" id="results-panel">
            <div class="flex justify-center">
                <div class="hidden bg-slate-900/80 backdrop-blur-md border border-slate-800 rounded-full px-6 py-2 text-sm font-bold shadow-lg"
                    id="aiScore">
                    AI Score: <span class="text-blue-400">--/10</span>
                </div>
            </div>

            <div class="hidden glass-card rounded-2xl p-5" id="metricsPanel">
                <div class="flex items-center gap-2 mb-4 border-b border-white/5 pb-3">
                    <span class="material-symbols-outlined text-emerald-400 text-sm">monitoring</span>
                    <h3 class="text-sm font-semibold text-slate-300 uppercase tracking-wider">Rewritten Text Metrics
                    </h3>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3" id="metricsGrid"></div>
            </div>

            <!-- Per-Paragraph Analysis -->
            <div class="hidden glass-card rounded-2xl p-5" id="paraAnalysisPanel">
                <div class="flex items-center gap-2 mb-4 border-b border-white/5 pb-3">
                    <span class="material-symbols-outlined text-violet-400 text-sm">format_list_numbered</span>
                    <h3 class="text-sm font-semibold text-slate-300 uppercase tracking-wider">Per-Paragraph Analysis</h3>
                </div>
                <div class="space-y-2" id="paraAnalysisGrid"></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Original / Cleaned Column -->
                <div class="glass-card rounded-2xl p-5 flex flex-col h-full">
                    <div class="flex items-center gap-2 mb-4 border-b border-white/5 pb-3">
                        <span class="material-symbols-outlined text-slate-500 text-sm">history_edu</span>
                        <h3 class="text-sm font-semibold text-slate-300 uppercase tracking-wider">Original / Cleaned
                        </h3>
                    </div>
                    <textarea
                        class="w-full flex-grow bg-transparent border-none text-slate-400 text-sm font-mono resize-none focus:ring-0 p-0 min-h-[250px]"
                        id="cleanResult" readonly></textarea>
                </div>

                <!-- Final Output Column -->
                <div class="glass-card rounded-2xl p-5 flex flex-col h-full relative overflow-hidden">
                    <div class="absolute inset-0 bg-gradient-to-br from-blue-500/5 to-indigo-500/5 pointer-events-none">
                    </div>

                    <!-- Tabs: Text / Diff -->
                    <div class="flex items-center justify-between mb-4 border-b border-white/5 pb-3 relative z-10">
                        <div class="flex items-center gap-4">
                            <button class="text-sm font-semibold pb-1 tab-active transition-colors" id="tabText"
                                onclick="switchTab('text')">
                                <span class="material-symbols-outlined text-[14px] align-middle mr-1">psychology</span>Final Output
                            </button>
                            <button class="text-sm font-semibold pb-1 tab-inactive transition-colors" id="tabDiff"
                                onclick="switchTab('diff')">
                                <span class="material-symbols-outlined text-[14px] align-middle mr-1">compare</span>Diff View
                            </button>
                        </div>
                        <div class="flex items-center gap-2">
                            <button
                                class="text-xs text-blue-300 hover:text-white flex items-center gap-1 bg-blue-500/10 px-2 py-1 rounded hover:bg-blue-500/20 transition-colors"
                                onclick="copyResult()" id="copyBtn">
                                <span class="material-symbols-outlined text-[14px]">content_copy</span> Copy
                            </button>
                            <button
                                class="text-xs text-emerald-300 hover:text-white flex items-center gap-1 bg-emerald-500/10 px-2 py-1 rounded hover:bg-emerald-500/20 transition-colors"
                                onclick="downloadResult()">
                                <span class="material-symbols-outlined text-[14px]">download</span> Download
                            </button>
                        </div>
                    </div>

                    <textarea
                        class="w-full flex-grow bg-transparent border-none text-slate-200 text-sm leading-relaxed resize-none focus:ring-0 p-0 relative z-10 min-h-[250px]"
                        id="finalResult" readonly></textarea>

                    <div class="hidden diff-view overflow-y-auto relative z-10 min-h-[250px] max-h-[400px]" id="diffView"></div>
                </div>
            </div>

            <div class="glass-card rounded-2xl p-6">
                <h3 class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-4 flex items-center gap-2">
                    <span class="material-symbols-outlined text-sm">terminal</span>
                    Change Log
                </h3>
                <div class="bg-slate-950/50 rounded-lg p-4 font-mono text-xs text-slate-400 max-h-40 overflow-y-auto border border-slate-800/50 mb-6"
                    id="changesLog">
                </div>

                <div class="flex justify-center pt-2">
                    <button
                        class="flex items-center gap-2 px-6 py-2.5 rounded-full border border-slate-700 text-slate-300 hover:bg-slate-800 hover:text-white transition-all text-sm font-medium"
                        onclick="reset()">
                        <span class="material-symbols-outlined text-[18px]">refresh</span>
                        Start New Task
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let _originalText = '';
        let _rewrittenText = '';

        const STRENGTH_MAP = ['light', 'medium', 'aggressive'];
        const STRENGTH_COLORS = {
            light: { bg: 'rgba(34, 197, 94, 0.15)', fg: '#4ade80' },
            medium: { bg: 'rgba(234, 179, 8, 0.15)', fg: '#facc15' },
            aggressive: { bg: 'rgba(239, 68, 68, 0.15)', fg: '#f87171' }
        };

        function updateStrengthLabel(val) {
            const name = STRENGTH_MAP[val];
            const label = document.getElementById('strengthLabel');
            const colors = STRENGTH_COLORS[name];
            label.textContent = name.charAt(0).toUpperCase() + name.slice(1);
            label.style.background = colors.bg;
            label.style.color = colors.fg;
        }

        function getStrength() {
            return STRENGTH_MAP[document.getElementById('strengthSlider').value];
        }

        const fileInput = document.getElementById('fileInput');

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            document.getElementById('loading').style.display = 'block';

            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorElem = await response.json();
                    throw new Error(errorElem.detail || 'Upload failed');
                }

                const data = await response.json();
                document.getElementById('rawText').value = data.content;

            } catch (err) {
                alert('Error uploading file: ' + err.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        });

        async function processText(action) {
            const text = document.getElementById('rawText').value;
            if (!text) {
                alert('Please enter some text first.');
                return;
            }

            _originalText = text;

            document.getElementById('loading').style.display = 'block';
            document.getElementById('input-panel').classList.add('opacity-50', 'pointer-events-none');

            const formData = new FormData();
            formData.append('action', action);
            formData.append('text', text);
            formData.append('strength', getStrength());

            try {
                const response = await fetch('/api/process', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorElem = await response.json();
                    throw new Error(errorElem.detail || 'Processing failed');
                }

                if (action === 'rewrite') {
                    document.getElementById('results-panel').classList.remove('hidden');
                    document.getElementById('input-panel').classList.add('hidden');

                    document.getElementById('cleanResult').value = 'Sanitizing...';
                    document.getElementById('finalResult').value = '';
                    document.getElementById('aiScore').classList.add('hidden');
                    document.getElementById('changesLog').innerHTML = '<div class="text-slate-500 italic">Processing...</div>';

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';

                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;

                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');

                        buffer = lines.pop() || '';

                        for (const line of lines) {
                            if (!line.trim()) continue;
                            try {
                                const msg = JSON.parse(line);
                                handleStreamEvent(msg);
                            } catch (e) {
                                console.error('Error parsing stream line', e);
                            }
                        }
                    }

                    if (buffer.trim()) {
                        try {
                            const msg = JSON.parse(buffer);
                            handleStreamEvent(msg);
                        } catch (e) {
                            console.error('Error parsing final stream line', e);
                        }
                    }

                } else {
                    const data = await response.json();
                    showResults(data, action);
                }

            } catch (err) {
                alert('Error processing text: ' + err.message);
                if (document.getElementById('results-panel').classList.contains('hidden')) {
                    document.getElementById('input-panel').classList.remove('opacity-50', 'pointer-events-none');
                }
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('input-panel').classList.remove('opacity-50', 'pointer-events-none');
            }
        }

        function handleStreamEvent(msg) {
            if (msg.type === 'stage') {
                if (msg.data.step === 'clean') {
                    document.getElementById('cleanResult').value = msg.data.clean_text;
                } else if (msg.data.step === 'analyzed') {
                    document.getElementById('changesLog').innerHTML = '<div class="text-amber-400 animate-pulse flex items-center gap-2"><span class="loader h-3 w-3 border-t-amber-400"></span> Rewriting with AI logic...</div>';
                } else if (msg.data.step === 'humanizing') {
                    document.getElementById('changesLog').innerHTML = '<div class="text-purple-400 animate-pulse flex items-center gap-2"><span class="loader h-3 w-3 border-t-purple-400"></span> Humanizing text patterns...</div>';
                } else if (msg.data.step === 'verifying') {
                    document.getElementById('changesLog').innerHTML = '<div class="text-blue-400 animate-pulse flex items-center gap-2"><span class="loader h-3 w-3 border-t-blue-400"></span> Verifying improvements...</div>';
                }
            } else if (msg.type === 'chunk') {
                const finalResult = document.getElementById('finalResult');
                finalResult.value += msg.data;
                finalResult.scrollTop = finalResult.scrollHeight;
            } else if (msg.type === 'done') {
                const data = msg.data;
                showResults(data, 'rewrite');
            } else if (msg.type === 'error') {
                console.error(msg.data);
            }
        }

        function showResults(data, action) {
            document.getElementById('results-panel').classList.remove('hidden');
            document.getElementById('input-panel').classList.add('hidden');

            document.getElementById('cleanResult').value = data.clean_text;

            if (action === 'rewrite') {
                _rewrittenText = data.rewritten_text;
                document.getElementById('finalResult').value = data.rewritten_text;

                const originalScore = data.original_text_ai_score;
                const scoreEl = document.getElementById('aiScore');
                const getScoreClass = (s) => s >= 7 ? 'text-red-400' : (s >= 4 ? 'text-amber-400' : 'text-emerald-400');
                const getBorderClass = (s) => s >= 7 ? 'border-red-500/30' : (s >= 4 ? 'border-amber-500/30' : 'border-emerald-500/30');

                scoreEl.classList.remove('hidden');
                scoreEl.innerHTML = `
                    <span class="text-slate-400 font-medium mr-2">Original AI Score:</span>
                    <span class="${getScoreClass(originalScore)}">${originalScore}/10</span>
                `;
                scoreEl.className = `bg-slate-900/80 backdrop-blur-md border ${getBorderClass(originalScore)} rounded-full px-6 py-2 text-sm font-bold shadow-lg inline-flex items-center justify-center`;

                if (data.rewritten_metrics) {
                    renderMetrics(data.rewritten_metrics);
                    renderParaAnalysis(data.clean_text, data.rewritten_text, data.rewritten_metrics);
                }

                buildDiffView(data.clean_text, data.rewritten_text);

            } else {
                document.getElementById('finalResult').value = data.clean_text;
                document.getElementById('aiScore').classList.add('hidden');
                document.getElementById('metricsPanel').classList.add('hidden');
                document.getElementById('paraAnalysisPanel').classList.add('hidden');
            }

            const logDiv = document.getElementById('changesLog');
            logDiv.innerHTML = '';

            if (data.changes && data.changes.length > 0) {
                data.changes.forEach((c, i) => {
                    const div = document.createElement('div');
                    div.className = 'py-1 border-b border-slate-800 last:border-0';
                    div.innerHTML = `<span class="text-slate-600 mr-2">${i + 1}.</span> ${c.description}`;
                    logDiv.appendChild(div);
                });
            } else {
                logDiv.textContent = 'No changes detected.';
            }
        }

        function renderMetrics(metrics) {
            const panel = document.getElementById('metricsPanel');
            const grid = document.getElementById('metricsGrid');
            panel.classList.remove('hidden');
            grid.innerHTML = '';

            const items = [];

            const sv = metrics.sentence_variance || {};
            if (sv.category) {
                const good = sv.category === 'burstive';
                const ok = sv.category === 'moderate';
                items.push({ label: 'Sentence Variety', value: sv.category, good: good, ok: ok });
            }

            const ap = metrics.ai_phrases || {};
            if (ap.count !== undefined) {
                items.push({ label: 'AI Phrases', value: ap.count === 0 ? 'None found' : ap.count + ' found', good: ap.count === 0, ok: ap.count <= 2 });
            }

            const hd = metrics.hedging || {};
            if (hd.filler_density !== undefined) {
                const low = hd.filler_density < 0.02;
                items.push({ label: 'Hedging Density', value: low ? 'Low' : 'Elevated', good: low, ok: hd.filler_density < 0.04 });
            }

            const vf = metrics.verb_frequency || {};
            if (vf.ai_verb_density !== undefined) {
                const low = vf.ai_verb_density < 0.1;
                items.push({ label: 'AI Verbs', value: low ? 'Low' : 'Elevated', good: low, ok: vf.ai_verb_density < 0.2 });
            }

            const rep = metrics.repetition || {};
            if (rep.count !== undefined) {
                items.push({ label: 'Repetition', value: rep.count === 0 ? 'None' : rep.count + ' phrases', good: rep.count === 0, ok: rep.count <= 2 });
            }

            const pp = metrics.punctuation_profile || {};
            if (pp.structure_ratio !== undefined) {
                const balanced = pp.structure_ratio < 0.7;
                items.push({ label: 'Punctuation', value: balanced ? 'Varied' : 'Rigid', good: balanced, ok: pp.structure_ratio < 0.85 });
            }

            items.forEach(item => {
                const colorClass = item.good ? 'text-emerald-400 border-emerald-500/20 bg-emerald-500/5' : (item.ok ? 'text-amber-400 border-amber-500/20 bg-amber-500/5' : 'text-red-400 border-red-500/20 bg-red-500/5');
                const icon = item.good ? 'check_circle' : (item.ok ? 'warning' : 'error');
                const div = document.createElement('div');
                div.className = `rounded-xl border px-3 py-2.5 ${colorClass}`;
                div.innerHTML = `
                    <div class="flex items-center gap-1.5 mb-1">
                        <span class="material-symbols-outlined text-[14px]">${icon}</span>
                        <span class="text-[10px] uppercase tracking-wider font-semibold text-slate-400">${item.label}</span>
                    </div>
                    <span class="text-sm font-medium">${item.value}</span>
                `;
                grid.appendChild(div);
            });
        }

        // Per-Paragraph Analysis (Step 7)
        function renderParaAnalysis(originalText, rewrittenText, metrics) {
            const panel = document.getElementById('paraAnalysisPanel');
            const grid = document.getElementById('paraAnalysisGrid');
            panel.classList.remove('hidden');
            grid.innerHTML = '';

            const paragraphs = rewrittenText.split(/\n\n+/).filter(p => p.trim().length > 0);
            if (paragraphs.length <= 1) {
                panel.classList.add('hidden');
                return;
            }

            paragraphs.forEach((para, i) => {
                const wordCount = para.split(/\s+/).length;
                const sentences = para.split(/(?<=[.!?])\s+/).filter(s => s.trim());
                const avgSentLen = sentences.length > 0 ? Math.round(wordCount / sentences.length) : wordCount;

                const hasAiPhrase = (metrics.ai_phrases?.phrases || []).some(p => para.toLowerCase().includes(p));
                const sentLengths = sentences.map(s => s.split(/\s+/).length);
                const variance = sentLengths.length > 1 ?
                    Math.round(sentLengths.reduce((sum, len) => sum + Math.pow(len - avgSentLen, 2), 0) / sentLengths.length) : 0;

                let score = 'good';
                let scoreLabel = 'Natural';
                let scoreColor = 'emerald';
                if (hasAiPhrase) { score = 'bad'; scoreLabel = 'AI Phrase'; scoreColor = 'red'; }
                else if (variance < 5 && sentences.length > 2) { score = 'warn'; scoreLabel = 'Uniform'; scoreColor = 'amber'; }
                else if (avgSentLen > 25) { score = 'warn'; scoreLabel = 'Long sentences'; scoreColor = 'amber'; }

                const div = document.createElement('div');
                div.className = `para-score flex items-start gap-3 p-3 rounded-xl border border-${scoreColor}-500/20 bg-${scoreColor}-500/5`;
                div.innerHTML = `
                    <div class="flex-shrink-0 w-7 h-7 rounded-full bg-${scoreColor}-500/20 flex items-center justify-center text-${scoreColor}-400 text-xs font-bold">${i + 1}</div>
                    <div class="flex-grow min-w-0">
                        <p class="text-xs text-slate-400 truncate mb-1">${para.substring(0, 80)}${para.length > 80 ? '...' : ''}</p>
                        <div class="flex gap-3 text-[10px] text-slate-500">
                            <span>${wordCount} words</span>
                            <span>${sentences.length} sentences</span>
                            <span>Avg: ${avgSentLen} w/s</span>
                        </div>
                    </div>
                    <span class="flex-shrink-0 text-[10px] font-bold uppercase tracking-wider px-2 py-0.5 rounded-full bg-${scoreColor}-500/15 text-${scoreColor}-400">${scoreLabel}</span>
                `;
                grid.appendChild(div);
            });
        }

        // Diff View (Step 4)
        function buildDiffView(original, rewritten) {
            const diffEl = document.getElementById('diffView');

            const origWords = original.split(/(\s+)/);
            const newWords = rewritten.split(/(\s+)/);

            const origSet = new Set(origWords.filter(w => w.trim()));
            const newSet = new Set(newWords.filter(w => w.trim()));

            let html = '<div class="mb-3 pb-2 border-b border-white/5">';
            html += '<span class="text-[10px] uppercase tracking-wider font-semibold text-slate-500">Original â†’ Rewritten differences</span>';
            html += '</div>';

            html += '<div class="mb-4"><span class="text-[10px] uppercase tracking-wider font-semibold text-slate-600 mr-3">Original:</span>';
            origWords.forEach(word => {
                if (!word.trim()) { html += word; return; }
                if (!newSet.has(word)) {
                    html += `<span class="diff-removed">${word}</span>`;
                } else {
                    html += word;
                }
            });
            html += '</div>';

            html += '<div><span class="text-[10px] uppercase tracking-wider font-semibold text-slate-600 mr-3">Rewritten:</span>';
            newWords.forEach(word => {
                if (!word.trim()) { html += word; return; }
                if (!origSet.has(word)) {
                    html += `<span class="diff-added">${word}</span>`;
                } else {
                    html += word;
                }
            });
            html += '</div>';

            diffEl.innerHTML = html;
        }

        // Tab Switching
        function switchTab(tab) {
            const textEl = document.getElementById('finalResult');
            const diffEl = document.getElementById('diffView');
            const tabText = document.getElementById('tabText');
            const tabDiff = document.getElementById('tabDiff');

            if (tab === 'text') {
                textEl.classList.remove('hidden');
                diffEl.classList.add('hidden');
                tabText.className = tabText.className.replace('tab-inactive', 'tab-active');
                tabDiff.className = tabDiff.className.replace('tab-active', 'tab-inactive');
            } else {
                textEl.classList.add('hidden');
                diffEl.classList.remove('hidden');
                tabDiff.className = tabDiff.className.replace('tab-inactive', 'tab-active');
                tabText.className = tabText.className.replace('tab-active', 'tab-inactive');
            }
        }

        function reset() {
            document.getElementById('results-panel').classList.add('hidden');
            document.getElementById('input-panel').classList.remove('hidden');
            document.getElementById('rawText').value = '';
            document.getElementById('fileInput').value = '';
            document.getElementById('paraAnalysisPanel').classList.add('hidden');
            switchTab('text');
            _originalText = '';
            _rewrittenText = '';
        }

        function clearText() {
            document.getElementById('rawText').value = '';
        }

        function copyResult() {
            const text = document.getElementById('finalResult').value;
            navigator.clipboard.writeText(text).then(() => {
                const btn = document.getElementById('copyBtn');
                const originalHTML = btn.innerHTML;
                btn.innerHTML = `<span class="material-symbols-outlined text-[14px]">check</span> Copied`;
                setTimeout(() => btn.innerHTML = originalHTML, 2000);
            });
        }

        function downloadResult() {
            const text = document.getElementById('finalResult').value;
            if (!text) return;
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'rewritten_text.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>

</html>